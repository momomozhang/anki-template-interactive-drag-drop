<script>
// anki-persistence library - same as front side
if (typeof(window.Persistence) === 'undefined') {
    var _persistenceKey = 'github.com/SimonLammer/anki-persistence/';
    var _defaultKey = '_default';
    window.Persistence_sessionStorage = function() {
        var isAvailable = false;
        try {
            if (typeof(window.sessionStorage) === 'object') {
                isAvailable = true;
                this.clear = function() {
                    for (var i = 0; i < sessionStorage.length; i++) {
                        var k = sessionStorage.key(i);
                        if (k.indexOf(_persistenceKey) == 0) {
                            sessionStorage.removeItem(k);
                            i--;
                        }
                    }
                };
                this.setItem = function(key, value) {
                    if (value == undefined) {
                        value = key;
                        key = _defaultKey;
                    }
                    sessionStorage.setItem(_persistenceKey + key, JSON.stringify(value));
                };
                this.getItem = function(key) {
                    if (key == undefined) {
                        key = _defaultKey;
                    }
                    return JSON.parse(sessionStorage.getItem(_persistenceKey + key));
                };
                this.removeItem = function(key) {
                    if (key == undefined) {
                        key = _defaultKey;
                    }
                    sessionStorage.removeItem(_persistenceKey + key);
                };
            }
        } catch(err) {}
        this.isAvailable = function() {
            return isAvailable;
        };
    };
    window.Persistence_windowKey = function(key) {
        var isAvailable = false;
        try {
            if (typeof(window[key]) === 'object') {
                isAvailable = true;
                this.clear = function() {
                    window[key] = {};
                };
                this.setItem = function(key, value) {
                    if (value == undefined) {
                        value = key;
                        key = _defaultKey;
                    }
                    window[key][_persistenceKey + key] = value;
                };
                this.getItem = function(key) {
                    if (key == undefined) {
                        key = _defaultKey;
                    }
                    return window[key][_persistenceKey + key];
                };
                this.removeItem = function(key) {
                    if (key == undefined) {
                        key = _defaultKey;
                    }
                    delete window[key][_persistenceKey + key];
                };
            }
        } catch(err) {}
        this.isAvailable = function() {
            return isAvailable;
        };
    };
    window.Persistence = new Persistence_sessionStorage();
    if (!window.Persistence.isAvailable()) {
        window.Persistence = new Persistence_windowKey(window.location.href);
        if (!window.Persistence.isAvailable()) {
            window.Persistence = new Persistence_windowKey('anki-persistence');
        }
    }
}

// Set solution flag for back side
if (window.Persistence && window.Persistence.isAvailable()) {
    window.Persistence.setItem('showSolution', true);
}

// Function to generate table structure (copied from front.html)
function generateTable(layout, headers) {
    let tableHTML = '';
    if (layout === 'V') {
        // Layout vertical
        tableHTML = `<table><thead><tr><th></th><th>Terms</th></tr></thead><tbody>`;
        headers.forEach((header, index) => {
            tableHTML += `<tr><th>${header}</th><td id="col${index + 1}-vert" class="dropzone"></td></tr>`;
        });
        tableHTML += `</tbody></table>`;
    } else {
        // Layout horizontal
        tableHTML = `<table><thead><tr>`;
        headers.forEach((header, index) => {
            tableHTML += `<th id="header${index + 1}">${header}</th>`;
        });
        tableHTML += `</tr></thead><tbody><tr>`;
        headers.forEach((header, index) => {
            tableHTML += `<td id="col${index + 1}" class="dropzone"></td>`;
        });
        tableHTML += `</tr></tbody></table>`;
    }
    return tableHTML;
}

// Function to display solution on back side
function displaySolution() {
    // Parse field data (copied from front.html)
    const layout = document.getElementById("layout-field").innerText.trim().toUpperCase();

    const headers = [
        document.getElementById("header1-field").innerText,
        document.getElementById("header2-field").innerText,
        document.getElementById("header3-field").innerText,
        document.getElementById("header4-field").innerText,
        document.getElementById("header5-field").innerText,
        document.getElementById("header6-field").innerText,
        document.getElementById("header7-field").innerText
    ];

    const terms = [
        document.getElementById("terms1-field").innerText.split("|"),
        document.getElementById("terms2-field").innerText.split("|"),
        document.getElementById("terms3-field").innerText.split("|"),
        document.getElementById("terms4-field").innerText.split("|"),
        document.getElementById("terms5-field").innerText.split("|"),
        document.getElementById("terms6-field").innerText.split("|"),
        document.getElementById("terms7-field").innerText.split("|")
    ];

    // Filter valid headers and terms
    const validHeaders = headers.filter((header, index) => header.trim() !== "" && terms[index].length > 0);
    const validTerms = terms.filter((termList, index) => headers[index].trim() !== "" && termList.length > 0);

    // Generate table structure
    const dynamicTable = document.getElementById("dynamic-table");
    if (dynamicTable) {
        dynamicTable.innerHTML = generateTable(layout, validHeaders);
        
        // Populate table with correct answers
        validTerms.forEach((categoryTerms, index) => {
            const dropzoneId = layout === 'V' ? `col${index + 1}-vert` : `col${index + 1}`;
            const dropzone = document.getElementById(dropzoneId);
            
            if (dropzone) {
                categoryTerms.forEach(termString => {
                    const terms = termString.split('|').map(t => t.trim());
                    terms.forEach(term => {
                        if (term) {
                            dropzone.innerHTML += `<div class="term correct">${term}<div class="question-plus-one"></div></div>`;
                        }
                    });
                });
            }
        });
        
        // Hide interactive elements
        const termsContainer = document.getElementById("terms-container");
        if (termsContainer) termsContainer.style.display = 'none';
        const checkButton = document.getElementById("checkButton");
        if (checkButton) checkButton.style.display = 'none';
    }
}
</script>
{{FrontSide}}
<script>
// Execute solution display after DOM is ready
setTimeout(function() {
    displaySolution();
}, 10);

// Clear persistence after back side is shown to prevent bleeding into next card
setTimeout(function() {
    if (window.Persistence && window.Persistence.isAvailable()) {
        window.Persistence.clear();
    }
}, 100);
</script>
